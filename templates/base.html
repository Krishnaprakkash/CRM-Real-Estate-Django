<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
</head>
<body style="font-family: Arial, sans-serif;">

    {% block content %}
    {% endblock %}

    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

    <!-- Tab Switching -->
    <script>
    function switchTab(evt, tabName) {
        var i, tabcontent, tablinks;
        
        // Hide all tab content
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
            tabcontent[i].style.display = "none";
        }
        
        // Remove active class from all tab links
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" active", "");
        }
        
        // Show selected tab and activate button
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " active";
    }

    // Show first tab by default on page load
    document.addEventListener('DOMContentLoaded', function() {
        const firstTab = document.querySelector('.tablinks');
        if (firstTab) {
            firstTab.click();
        }
    });
    </script>

    <!-- Batch Actions -->
    <script>
    function toggleSelectAll(source) {
        const table = source.closest('table');
        const checkboxes = document.querySelectorAll('input.listing-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        console.log(`Toggled ${checkboxes.length} checkboxes`);
    }
    
    function setAction(action, stage = 'lead') {
        console.log('Action clicked:', action);
        
        const selected = document.querySelectorAll('input.listing-checkbox:checked');
        if (selected.length === 0) {
            alert(`Please select at least one listing first!`);
            return;
        }
        
        if (action === 'reject') {
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || !reason.trim()) {
                alert('Rejection reason is required!');
                return;
            }
            document.getElementById('rejection-reason').value = reason;
        }

        if (action == 'approve') {
            if (!confirm(`Are you sure you want to approve the selected listings?`)) {
                return;
            }
        }
        
        document.getElementById('batch-action').value = action;
        document.getElementById('stage').value = stage;
        console.log(`Submitting ${selected.length} listings for ${action}`);
        document.getElementById('batch-form').submit();
    }
    </script>

    <!-- Manager DataTable Filters -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        if (document.getElementById('manager-leads-table')) {
            const table = $('#manager-leads-table').DataTable({
                order: [[0, 'desc']],
                pageLength: 10,
                lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                columnDefs: [{ orderable: false, targets: 6 }] 
            });

            const typeCol = 2;   
            const statusCol = 5;  
            const salesmanCol = 4; 

            setTimeout(() => populateFilters(table), 100);

            $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').on('change', filterTable);
            $('#clearFiltersLeads').click(clearFilters);

            function populateFilters(table) {
                populateFilter('#typeFilterLeads', table, typeCol);
                populateFilter('#statusFilterLeads', table, statusCol);
                populateFilter('#salesmanFilterLeads', table, salesmanCol);
            }

            function populateFilter(selector, table, colIndex) {
                const select = $(selector);
                const values = [];
                
                table.column(colIndex).nodes().to$().each(function() {
                    const cleanText = $(this).text().trim(); 
                    if (cleanText && !values.includes(cleanText)) {
                        values.push(cleanText);
                    }
                });
                
                values.sort().forEach(val => {
                    select.append(`<option value="${val}">${val}</option>`);
                });
            }

            function filterTable() {
                $.fn.dataTable.ext.search.pop();
                
                $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                    const row = table.row(dataIndex).node();
                    const typeCell = $(row).find('td:nth-child(3)').text().trim();
                    const statusCell = $(row).find('td:nth-child(6)').text().trim();
                    const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                          return (!$("#typeFilterLeads").val() || typeCell === $("#typeFilterLeads").val()) &&
                              (!$("#statusFilterLeads").val() || statusCell === $("#statusFilterLeads").val()) &&
                              (!$("#salesmanFilterLeads").val() || salesmanCell === $("#salesmanFilterLeads").val());
                });
                
                table.draw();
            }

            function clearFilters() {
                $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').val('').trigger('change');
            }
        }
    });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('manager-opps-table')) {
                const table = $('#manager-opps-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }] 
                });

                const typeCol = 2;   
                const statusCol = 5;  
                const salesmanCol = 4; 

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterOpps, #salesmanFilterOpps').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterOpps', table, typeCol);
                    populateFilter('#statusFilterOpps', table, statusCol);
                    populateFilter('#salesmanFilterOpps', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];
                    
                    table.column(colIndex).nodes().to$().each(function() {
                        const cleanText = $(this).text().trim(); 
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });
                    
                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();
                    
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterOpps").val() || typeCell === $("#typeFilterOpps").val()) &&
                            (!$("#statusFilterOpps").val() || statusCell === $("#statusFilterOpps").val()) &&   
                            (!$("#salesmanFilterOpps").val() || salesmanCell === $("#salesmanFilterOpps").val());
                    });
                    
                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterOpps, #salesmanFilterOpps, #statusFilterOpps').val('').trigger('change');
                }
            }
        });
    </script>



    <!-- Basic Tab Styling -->
    <style>
    .menu {
        margin: 20px 0;
    }
    
    .tablinks {
        padding: 12px 20px;
        border: 1px solid #ddd;
        background: #f1f1f1;
        cursor: pointer;
        margin-right: 2px;
    }
    
    .tablinks:hover {
        background: #ddd;
    }
    
    .tablinks.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .tabcontent {
        display: none;
        padding: 20px;
        border: 1px solid #ddd;
        margin-top: 10px;
    }
    </style>
</body>
</html>
