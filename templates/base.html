<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    {% block styles %}
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar .brand {
            padding: 20px;
            text-align: center;
            color: white;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
        }
        
        .sidebar .brand h3 {
            margin: 0;
            font-weight: bold;
        }
        
        .sidebar .brand small {
            opacity: 0.8;
        }
        
        .sidebar .nav-link {
            color: rgba(255,255,255,0.8);
            padding: 12px 20px;
            margin: 5px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active {
            background: rgba(255,255,255,0.2);
            color: white;
            font-weight: bold;
        }
        
        .sidebar .nav-link i {
            font-size: 1.2rem;
            width: 24px;
        }
        
        .sidebar .user-info {
            padding: 15px 20px;
            background: rgba(0,0,0,0.2);
            margin: 15px;
            border-radius: 8px;
            color: white;
        }
        
        .sidebar .user-info .user-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .sidebar .user-info .user-role {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px;
            min-height: 100vh;
            background: #f8f9fa;
        }
        
        .navbar-top {
            position: sticky;
            top: 0;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }
            .main-content {
                margin-left: 200px;
            }
        }
    </style>
    {% endblock %}
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <!-- Brand -->
        <div class="brand">
            <h3>üè¢ Real Estate CRM</h3>
            <small>Property Management</small>
        </div>
        
        <!-- User Info -->
        <div class="user-info">
            <div class="user-name">{{ request.user.get_full_name }}</div>
            <div class="user-role">
                <i class="bi bi-person-badge"></i> {{ request.user.role }}
            </div>
            <div class="user-role">
                <i class="bi bi-building"></i> {{ request.user.branch.name }}
            </div>
        </div>
        
        <!-- Navigation -->
        <nav class="nav flex-column">
            <!-- Home/Dashboard -->
            <a class="nav-link {% if request.resolver_match.url_name == 'home' or 'dashboard' in request.resolver_match.url_name %}active{% endif %}" 
               href="{% url 'dashboards:home' %}">
                <i class="bi bi-house-door"></i>
                <span>Home</span>
            </a>
            
            <!-- Profile -->
            <a class="nav-link {% if 'profile' in request.resolver_match.url_name %}active{% endif %}" 
               href="{% url 'accounts:profile' %}">
                <i class="bi bi-person-circle"></i>
                <span>Profile</span>
            </a>
            
            <!-- Sales (Expandable) -->
            {% if request.user.role == 'Salesman' %}
            <a class="nav-link {% if 'salesman_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
            href="{% url 'dashboards:salesman_dashboard' %}">
                <i class="bi bi-clipboard-check"></i>
                <span>Pipeline</span>
            </a>
            {% elif request.user.role == 'Manager' %}
            <a class="nav-link {% if 'manager_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
            href="{% url 'dashboards:manager_dashboard' %}">
                <i class="bi bi-people"></i>
                <span>Team Pipeline</span>
            </a>
            {% elif request.user.role == 'CEO' %}
            <a class="nav-link {% if 'ceo_dashboard' in request.resolver_match.url_name %}active{% endif %}" 
            href="{% url 'dashboards:ceo_dashboard' %}">
                <i class="bi bi-building"></i>
                <span>Organization</span>
            </a>
            {% endif %}

            
            <!-- Inventory -->
            <a class="nav-link {% if 'inventory' in request.resolver_match.url_name %}active{% endif %}" 
               href="{% url 'inventory:listing_list' %}">
                <i class="bi bi-box-seam"></i>
                <span>Inventory</span>
            </a>
            
            <!-- Settings (Managers & CEO only) -->
            {% if request.user.role == 'Manager' or request.user.role == 'CEO' %}
            <a class="nav-link {% if 'settings' in request.resolver_match.url_name %}active{% endif %}" 
               href="#settings">
                <i class="bi bi-gear"></i>
                <span>Settings</span>
            </a>
            {% endif %}
            
            <!-- Divider -->
            <hr style="border-color: rgba(255,255,255,0.2); margin: 20px;">
            
            <!-- Logout -->
            <a class="nav-link" href="{% url 'accounts:logout' %}" 
               onclick="return confirm('Are you sure you want to logout?')">
                <i class="bi bi-box-arrow-right"></i>
                <span>Logout</span>
            </a>
        </nav>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Navigation Bar -->
        <div class="navbar-top">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">{% block page_title %}Dashboard{% endblock %}</h4>
                    <small class="text-muted">{% block page_subtitle %}{% endblock %}</small>
                </div>
                <div>
                    <!-- Quick Actions -->
                    {% if request.user.role == 'Manager' %}
                    <a href="{% url 'inventory:listing_create_manager' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> New Listing
                    </a>
                    {% elif request.user.role == 'Salesman' %}
                    <a href="{% url 'inventory:listing_create_salesman' %}" class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> New Listing
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Messages -->
        {% if messages %}
        <div class="messages">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Page Content -->
        {% block content %}
        {% endblock %}
    </div>

    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

    <!-- Tab Switching -->
    <script>
        function switchTab(evt, tabName) {
            var i, tabcontent, tablinks, statsGroups;

            // Hide all tab content
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Hide all stats groups
            statsGroups = document.getElementsByClassName('stats-group');
            for (i = 0; i < statsGroups.length; i++) {
                statsGroups[i].style.display = 'none';
            }

            // Remove active class from all tab links
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Show selected tab content
            var contentElement = document.getElementById(tabName);
            if (contentElement && contentElement.classList.contains('tabcontent')) {
                contentElement.style.display = 'block';
            }

            // Show corresponding stats group (with 'stats-' prefix)
            var statsElement = document.getElementById('stats-' + tabName);
            if (statsElement && statsElement.classList.contains('stats-group')) {
                statsElement.style.display = 'flex';
            }

            evt.currentTarget.classList.add("active");
        }

        // Show first tab by default on page load
        document.addEventListener('DOMContentLoaded', function () {
            const firstTab = document.querySelector('.tablinks');
            if (firstTab) {
                firstTab.click();
            }
        });
    </script>

    <!-- Batch Actions -->
    <script>
        function toggleSelectAll(source) {
            const table = source.closest('table');
            if (!table) return;
            const checkboxes = table.querySelectorAll('input.listing-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            console.log(`Toggled ${checkboxes.length} checkboxes`);
        }

        function setAction(action, suffix = 'leads') {
            console.log('Action clicked:', action, 'for', suffix);

            const formSelector = `#batch-form-${suffix}`;
            const selected = document.querySelectorAll(`${formSelector} input.listing-checkbox:checked`);

            if (selected.length === 0) {
                alert(`Please select at least one listing first!`);
                return;
            }

            if (action === 'delete') {
                const confirmMsg = 'Are you sure you want to DELETE ${selected.length} listing(s)?\n\nThis action CANNOT BE UNDONE.'
                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            if (suffix === 'opps' && action !== 'delete') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const columnValue = row.cells[5]?.textContent?.trim();
                        if (columnValue !== 'Pending Approval') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, value: columnValue })
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert('Cannot perform batch action. ${invalidItems.length} item(s) have not been submitted for approval.')
                } 
            }

            if (suffix === 'opps') {
                const invalidItems = [];
                const invalidItems1 = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const columnValue = row.cells[5]?.textContent?.trim();
                        if (columnValue !== 'Pending Approval') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, value: columnValue });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot perform batch action. ${invalidItems.length} selected item(s) have not been submitted for approval.`);
                    return;
                }
            }

            if (action === 'reject') {
                const reason = prompt('Enter rejection reason (required):');
                if (!reason || !reason.trim()) {
                    alert('Rejection reason is required!');
                    return;
                }
                const rr = document.getElementById(`rejection-reason-${suffix}`);
                if (rr) rr.value = reason;
            }

            if (action == 'approve') {
                if (!confirm(`Are you sure you want to approve the selected listings?`)) {
                    return;
                }
            }

            const ba = document.getElementById(`batch-action-${suffix}`);
            const st = document.getElementById(`stage-${suffix}`);
            const bf = document.getElementById(`batch-form-${suffix}`);
            if (ba) ba.value = action;
            if (st) st.value = (st.value || '');
            console.log(`Submitting ${selected.length} listings for ${action} (form ${formSelector})`);
            if (bf) bf.submit();
        }

        function setSalesmanAction(action, suffix) {
            console.log('Salesman action clicked:', action, 'for', suffix);

            const formSelector = `#batch-form-${suffix}`;
            const selected = document.querySelectorAll(`${formSelector} input.listing-checkbox:checked`);

            if (selected.length === 0) {
                alert(`Please select at least one listing first!`);
                return;
            }

            if (action === 'delete') {
                const confirmMsg = 'Are you sure you want to DELETE ${selected.length} listing(s)?\n\nThis action CANNOT BE UNDONE.'
                if (!confirm(confirmMsg)) {
                    return;
                }
            }

            if (suffix === 'opps' && action !== 'delete') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const columnValue = row.cells[4]?.textContent?.trim();
                        if (columnValue !== 'Pending Approval') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, value: columnValue })
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert('Cannot perform batch action. ${invalidItems.length} item(s) have not been submitted for approval.')
                } 
            }

            // Validation for submitting opportunities
            if (suffix === 'opps' && action === 'negotiating') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell !== 'Prospecting') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are not in Prospecting status.`);
                    return;
                }
            }
            if (suffix === 'opps' && action === 'submit') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell !== 'Negotiating') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are not in Negotiating status.`);
                    return;
                }
            }
            if (suffix === 'opps' && action === 'submit') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell === 'Pending Approval' || statusCell === 'Approved') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are already submitted for approval. `);
                    return;
                }
            }

            // Validation for processing sales
            if (suffix === 'sale' && (action === 'process' || action === 'won' || action === 'lost')) {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        // Different validations based on action
                        if (action === 'process' && statusCell !== 'Processing') {
                            // Allow any status to move to Processing
                        } else if ((action === 'won' || action === 'lost') && statusCell !== 'Processing') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0 && (action === 'won' || action === 'lost')) {
                    alert(`Cannot mark as ${action}. ${invalidItems.length} selected item(s) are are already closed.`);
                    return;
                }
            }

            // Confirmations for critical actions
            const confirmations = {
                'submit': `Are you sure you want to submit ${selected.length} listing(s) for approval?`,
                'won': `Are you sure you want to mark ${selected.length} listing(s) as Closed Won?`,
                'lost': `Are you sure you want to mark ${selected.length} listing(s) as Closed Lost?`
            };

            if (confirmations[action]) {
                if (!confirm(confirmations[action])) {
                    return;
                }
            }

            const ba = document.getElementById(`batch-action-${suffix}`);
            const st = document.getElementById(`stage-${suffix}`);
            const bf = document.getElementById(`batch-form-${suffix}`);
            if (ba) ba.value = action;
            if (st) st.value = (st.value || '');
            console.log(`Submitting ${selected.length} listings for ${action} (form ${formSelector})`);
            if (bf) bf.submit();
        }
    </script>

    <!-- Manager DataTable Filters -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-leads-table')) {
                const table = $('#manager-leads-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').on('change', filterTable);
                $('#clearFiltersLeads').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterLeads', table, typeCol);
                    populateFilter('#statusFilterLeads', table, statusCol);
                    populateFilter('#salesmanFilterLeads', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterLeads").val() || typeCell === $("#typeFilterLeads").val()) &&
                            (!$("#statusFilterLeads").val() || statusCell === $("#statusFilterLeads").val()) &&
                            (!$("#salesmanFilterLeads").val() || salesmanCell === $("#salesmanFilterLeads").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-opps-table')) {
                const table = $('#manager-opps-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterOpps, #salesmanFilterOpps, #statusFilterOpps').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterOpps', table, typeCol);
                    populateFilter('#statusFilterOpps', table, statusCol);
                    populateFilter('#salesmanFilterOpps', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterOpps").val() || typeCell === $("#typeFilterOpps").val()) &&
                            (!$("#statusFilterOpps").val() || statusCell === $("#statusFilterOpps").val()) &&
                            (!$("#salesmanFilterOpps").val() || salesmanCell === $("#salesmanFilterOpps").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterOpps, #salesmanFilterOpps, #statusFilterOpps').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-sales-table')) {
                const table = $('#manager-sales-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterSale, #salesmanFilterSale, #statusFilterSale').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterSale', table, typeCol);
                    populateFilter('#statusFilterSale', table, statusCol);
                    populateFilter('#salesmanFilterSale', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterSale").val() || typeCell === $("#typeFilterSale").val()) &&
                            (!$("#statusFilterSale").val() || statusCell === $("#statusFilterSale").val()) &&
                            (!$("#salesmanFilterSale").val() || salesmanCell === $("#salesmanFilterSale").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterSale, #salesmanFilterSale, #statusFilterSale').val('').trigger('change');
                }
            }
        });
    </script>

    <!-- Salesman DataTable Filter-->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-leads-table')) {
                const table = $('#salesman-leads-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterLeads, #statusFilterLeads').on('change', filterTable);
                $('#clearFiltersLeads').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterLeads', table, typeCol);
                    populateFilter('#statusFilterLeads', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterLeads").val() || typeCell === $("#typeFilterLeads").val()) &&
                            (!$("#statusFilterLeads").val() || statusCell === $("#statusFilterLeads").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-opps-table')) {
                const table = $('#salesman-opps-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterOpps, #statusFilterOpps').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterOpps', table, typeCol);
                    populateFilter('#statusFilterOpps', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterOpps").val() || typeCell === $("#typeFilterOpps").val()) &&
                            (!$("#statusFilterOpps").val() || statusCell === $("#statusFilterOpps").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterOpps, #statusFilterOpps, #salesmanFilterOpps').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-sales-table')) {
                const table = $('#salesman-sales-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterSale, #statusFilterSale').on('change', filterTable);
                $('#clearFiltersSale').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterSale', table, typeCol);
                    populateFilter('#statusFilterSale', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterSale").val() || typeCell === $("#typeFilterSale").val()) &&
                            (!$("#statusFilterSale").val() || statusCell === $("#statusFilterSale").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterSales, #statusFilterSales, #salesmanFilterSales').val('').trigger('change');
                }
            }
        });
    </script>

    <!-- Basic Tab Styling -->
    <style>
        .menu {
            margin: 20px 0;
        }

        .tablinks {
            padding: 12px 20px;
            border: 1px solid #ddd;
            background: #f1f1f1;
            cursor: pointer;
            margin-right: 2px;
        }

        .tablinks:hover {
            background: #ddd;
        }

        .tablinks.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
    </style>

    {% block scripts %}{% endblock %}
</body>

</html>