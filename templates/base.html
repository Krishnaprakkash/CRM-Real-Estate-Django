<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        {% block title %} CRM {% endblock %}
    </title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
</head>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

<script>
    function toggleSelectAll(source) {
        const table = source.closest('table');
        const checkboxes = document.querySelectorAll('input.listing-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        console.log(`Toggled ${checkboxes.length} checkboxes`);
    }
    
    function setAction(action) {
        console.log('Action clicked:', action);
        
        const selected = document.querySelectorAll('input.listing-checkbox:checked');
        if (selected.length === 0) {
            alert(`Please select at least one listing first!`);
            return;
        }
        
        if (action === 'reject') {
            const reason = prompt('Enter rejection reason (required):');
            if (!reason || !reason.trim()) {
                alert('Rejection reason is required!');
                return;
            }
            document.getElementById('rejection-reason').value = reason;
        }
        
        document.getElementById('batch-action').value = action;
        console.log(`Submitting ${selected.length} listings for ${action}`);
        document.getElementById('batch-form').submit();
    }
    </script>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const table = $('#manager-listings-table').DataTable({
        order: [[0, 'desc']],
        pageLength: 10,
        lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
        columnDefs: [{ orderable: false, targets: 6 }] 
    });

    const typeCol = 2;   
    const statusCol = 5;  
    const salesmanCol = 4; 

    setTimeout(() => populateFilters(table), 100);

    $('#typeFilter, #statusFilter, #salesmanFilter').on('change', filterTable);
    $('#clearFilters').click(clearFilters);

    function populateFilters(table) {
        populateFilter('#typeFilter', table, typeCol);
        populateFilter('#statusFilter', table, statusCol);
        populateFilter('#salesmanFilter', table, salesmanCol);
    }

    function populateFilter(selector, table, colIndex) {
        const select = $(selector);
        const values = [];
        

        table.column(colIndex).nodes().to$().each(function() {
            const cleanText = $(this).text().trim(); 
            if (cleanText && !values.includes(cleanText)) {
                values.push(cleanText);
            }
        });
        
        values.sort().forEach(val => {
            select.append(`<option value="${val}">${val}</option>`);
        });
    }

    function filterTable() {
        $.fn.dataTable.ext.search.pop();
        
        $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
            const row = table.row(dataIndex).node();
            const typeCell = $(row).find('td:nth-child(3)').text().trim();
            const statusCell = $(row).find('td:nth-child(6)').text().trim();
            const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

            return (!$("#typeFilter").val() || typeCell === $("#typeFilter").val()) &&
                   (!$("#statusFilter").val() || statusCell === $("#statusFilter").val()) &&
                   (!$("#salesmanFilter").val() || salesmanCell === $("#salesmanFilter").val());
        });
        
        table.draw();
    }

    function clearFilters() {
        $('#typeFilter, #statusFilter, #salesmanFilter').val('').trigger('change');
    }
});
</script>

<body>
    {% block content %}
    {% endblock %}
</body>
</html>