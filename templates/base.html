<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    {% block styles %}{% endblock %}
</head>

<body style="font-family: Arial, sans-serif;">

    {% block content %}
    {% endblock %}

    <!-- jQuery and DataTables -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

    <!-- Tab Switching -->
    <script>
        function switchTab(evt, tabName) {
            var i, tabcontent, tablinks, statsGroups;

            // Hide all tab content
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Hide all stats groups
            statsGroups = document.getElementsByClassName('stats-group');
            for (i = 0; i < statsGroups.length; i++) {
                statsGroups[i].style.display = 'none';
            }

            // Remove active class from all tab links
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }

            // Show selected tab content
            var contentElement = document.getElementById(tabName);
            if (contentElement && contentElement.classList.contains('tabcontent')) {
                contentElement.style.display = 'block';
            }

            // Show corresponding stats group (with 'stats-' prefix)
            var statsElement = document.getElementById('stats-' + tabName);
            if (statsElement && statsElement.classList.contains('stats-group')) {
                statsElement.style.display = 'flex';
            }

            evt.currentTarget.classList.add("active");
        }

        // Show first tab by default on page load
        document.addEventListener('DOMContentLoaded', function () {
            const firstTab = document.querySelector('.tablinks');
            if (firstTab) {
                firstTab.click();
            }
        });
    </script>

    <!-- Batch Actions -->
    <script>
        function toggleSelectAll(source) {
            const table = source.closest('table');
            if (!table) return;
            const checkboxes = table.querySelectorAll('input.listing-checkbox');
            checkboxes.forEach(cb => cb.checked = source.checked);
            console.log(`Toggled ${checkboxes.length} checkboxes`);
        }

        function setAction(action, suffix = 'leads') {
            console.log('Action clicked:', action, 'for', suffix);

            const formSelector = `#batch-form-${suffix}`;
            const selected = document.querySelectorAll(`${formSelector} input.listing-checkbox:checked`);

            if (selected.length === 0) {
                alert(`Please select at least one listing first!`);
                return;
            }

            if (suffix === 'opps') {
                const invalidItems = [];
                const invalidItems1 = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const columnValue = row.cells[5]?.textContent?.trim();
                        if (columnValue !== 'Pending Approval') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, value: columnValue });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot perform batch action. ${invalidItems.length} selected item(s) have not been submitted for approval.`);
                    return;
                }
            }

            if (action === 'reject') {
                const reason = prompt('Enter rejection reason (required):');
                if (!reason || !reason.trim()) {
                    alert('Rejection reason is required!');
                    return;
                }
                const rr = document.getElementById(`rejection-reason-${suffix}`);
                if (rr) rr.value = reason;
            }

            if (action == 'approve') {
                if (!confirm(`Are you sure you want to approve the selected listings?`)) {
                    return;
                }
            }

            const ba = document.getElementById(`batch-action-${suffix}`);
            const st = document.getElementById(`stage-${suffix}`);
            const bf = document.getElementById(`batch-form-${suffix}`);
            if (ba) ba.value = action;
            if (st) st.value = (st.value || '');
            console.log(`Submitting ${selected.length} listings for ${action} (form ${formSelector})`);
            if (bf) bf.submit();
        }

        function setSalesmanAction(action, suffix) {
            console.log('Salesman action clicked:', action, 'for', suffix);

            const formSelector = `#batch-form-${suffix}`;
            const selected = document.querySelectorAll(`${formSelector} input.listing-checkbox:checked`);

            if (selected.length === 0) {
                alert(`Please select at least one listing first!`);
                return;
            }

            // Validation for submitting opportunities
            if (suffix === 'opps' && action === 'negotiating') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell !== 'Prospecting') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are not in Prospecting status.`);
                    return;
                }
            }
            if (suffix === 'opps' && action === 'submit') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell !== 'Negotiating') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are not in Negotiating status.`);
                    return;
                }
            }
            if (suffix === 'opps' && action === 'submit') {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        if (statusCell === 'Pending Approval' || statusCell === 'Approved') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0) {
                    alert(`Cannot submit for approval. ${invalidItems.length} selected item(s) are already submitted for approval. `);
                    return;
                }
            }

            // Validation for processing sales
            if (suffix === 'sale' && (action === 'process' || action === 'won' || action === 'lost')) {
                const invalidItems = [];
                selected.forEach((checkbox) => {
                    const row = checkbox.closest('tr');
                    if (row) {
                        const statusCell = row.cells[4]?.textContent?.trim();
                        // Different validations based on action
                        if (action === 'process' && statusCell !== 'Processing') {
                            // Allow any status to move to Processing
                        } else if ((action === 'won' || action === 'lost') && statusCell !== 'Processing') {
                            const itemId = checkbox.value || row.cells[0]?.textContent?.trim();
                            invalidItems.push({ id: itemId, status: statusCell });
                        }
                    }
                });
                if (invalidItems.length > 0 && (action === 'won' || action === 'lost')) {
                    alert(`Cannot mark as ${action}. ${invalidItems.length} selected item(s) are are already closed.`);
                    return;
                }
            }

            // Confirmations for critical actions
            const confirmations = {
                'submit': `Are you sure you want to submit ${selected.length} listing(s) for approval?`,
                'won': `Are you sure you want to mark ${selected.length} listing(s) as Closed Won?`,
                'lost': `Are you sure you want to mark ${selected.length} listing(s) as Closed Lost?`
            };

            if (confirmations[action]) {
                if (!confirm(confirmations[action])) {
                    return;
                }
            }

            const ba = document.getElementById(`batch-action-${suffix}`);
            const st = document.getElementById(`stage-${suffix}`);
            const bf = document.getElementById(`batch-form-${suffix}`);
            if (ba) ba.value = action;
            if (st) st.value = (st.value || '');
            console.log(`Submitting ${selected.length} listings for ${action} (form ${formSelector})`);
            if (bf) bf.submit();
        }
    </script>

    <!-- Manager DataTable Filters -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-leads-table')) {
                const table = $('#manager-leads-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').on('change', filterTable);
                $('#clearFiltersLeads').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterLeads', table, typeCol);
                    populateFilter('#statusFilterLeads', table, statusCol);
                    populateFilter('#salesmanFilterLeads', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterLeads").val() || typeCell === $("#typeFilterLeads").val()) &&
                            (!$("#statusFilterLeads").val() || statusCell === $("#statusFilterLeads").val()) &&
                            (!$("#salesmanFilterLeads").val() || salesmanCell === $("#salesmanFilterLeads").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-opps-table')) {
                const table = $('#manager-opps-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterOpps, #salesmanFilterOpps, #statusFilterOpps').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterOpps', table, typeCol);
                    populateFilter('#statusFilterOpps', table, statusCol);
                    populateFilter('#salesmanFilterOpps', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterOpps").val() || typeCell === $("#typeFilterOpps").val()) &&
                            (!$("#statusFilterOpps").val() || statusCell === $("#statusFilterOpps").val()) &&
                            (!$("#salesmanFilterOpps").val() || salesmanCell === $("#salesmanFilterOpps").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterOpps, #salesmanFilterOpps, #statusFilterOpps').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('manager-sales-table')) {
                const table = $('#manager-sales-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 6 }]
                });

                const typeCol = 2;
                const statusCol = 5;
                const salesmanCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterSale, #salesmanFilterSale, #statusFilterSale').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterSale', table, typeCol);
                    populateFilter('#statusFilterSale', table, statusCol);
                    populateFilter('#salesmanFilterSale', table, salesmanCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(6)').text().trim();
                        const salesmanCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterSale").val() || typeCell === $("#typeFilterSale").val()) &&
                            (!$("#statusFilterSale").val() || statusCell === $("#statusFilterSale").val()) &&
                            (!$("#salesmanFilterSale").val() || salesmanCell === $("#salesmanFilterSale").val());
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterSale, #salesmanFilterSale, #statusFilterSale').val('').trigger('change');
                }
            }
        });
    </script>

    <!-- Salesman DataTable Filter-->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-leads-table')) {
                const table = $('#salesman-leads-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterLeads, #statusFilterLeads').on('change', filterTable);
                $('#clearFiltersLeads').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterLeads', table, typeCol);
                    populateFilter('#statusFilterLeads', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterLeads").val() || typeCell === $("#typeFilterLeads").val()) &&
                            (!$("#statusFilterLeads").val() || statusCell === $("#statusFilterLeads").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterLeads, #statusFilterLeads, #salesmanFilterLeads').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-opps-table')) {
                const table = $('#salesman-opps-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterOpps, #statusFilterOpps').on('change', filterTable);
                $('#clearFiltersOpps').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterOpps', table, typeCol);
                    populateFilter('#statusFilterOpps', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterOpps").val() || typeCell === $("#typeFilterOpps").val()) &&
                            (!$("#statusFilterOpps").val() || statusCell === $("#statusFilterOpps").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterOpps, #statusFilterOpps, #salesmanFilterOpps').val('').trigger('change');
                }
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            if (document.getElementById('salesman-sales-table')) {
                const table = $('#salesman-sales-table').DataTable({
                    order: [[0, 'desc']],
                    pageLength: 10,
                    lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    columnDefs: [{ orderable: false, targets: 4 }]
                });

                const typeCol = 2;
                const statusCol = 4;

                setTimeout(() => populateFilters(table), 100);

                $('#typeFilterSale, #statusFilterSale').on('change', filterTable);
                $('#clearFiltersSale').click(clearFilters);

                function populateFilters(table) {
                    populateFilter('#typeFilterSale', table, typeCol);
                    populateFilter('#statusFilterSale', table, statusCol);
                }

                function populateFilter(selector, table, colIndex) {
                    const select = $(selector);
                    const values = [];

                    table.column(colIndex).nodes().to$().each(function () {
                        const cleanText = $(this).text().trim();
                        if (cleanText && !values.includes(cleanText)) {
                            values.push(cleanText);
                        }
                    });

                    values.sort().forEach(val => {
                        select.append(`<option value="${val}">${val}</option>`);
                    });
                }

                function filterTable() {
                    $.fn.dataTable.ext.search.pop();

                    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
                        const row = table.row(dataIndex).node();
                        const typeCell = $(row).find('td:nth-child(3)').text().trim();
                        const statusCell = $(row).find('td:nth-child(5)').text().trim();

                        return (!$("#typeFilterSale").val() || typeCell === $("#typeFilterSale").val()) &&
                            (!$("#statusFilterSale").val() || statusCell === $("#statusFilterSale").val())
                    });

                    table.draw();
                }

                function clearFilters() {
                    $('#typeFilterSales, #statusFilterSales, #salesmanFilterSales').val('').trigger('change');
                }
            }
        });
    </script>

    <!-- Basic Tab Styling -->
    <style>
        .menu {
            margin: 20px 0;
        }

        .tablinks {
            padding: 12px 20px;
            border: 1px solid #ddd;
            background: #f1f1f1;
            cursor: pointer;
            margin-right: 2px;
        }

        .tablinks:hover {
            background: #ddd;
        }

        .tablinks.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .tabcontent {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
    </style>

    {% block scripts %}{% endblock %}
</body>

</html>