{% extends 'dashboards/base_dashboard.html' %}

{% block title %}Manager Dashboard{% endblock %}

{% block content %}

{{ block.super }}

<div id="lead" class="tabcontent" style="display: block;">
    <form method="post" id="batch-form-leads">
        {% csrf_token %}
        <input type="hidden" name="action" id="batch-action-leads" value="">
        <input type="hidden" name="rejection-reason" id="rejection-reason-leads" value="">
        <input type="hidden" name="stage" id="stage-leads" value="lead">
        <div>
            <div>
                <label>Property Type:</label>
                <select id="typeFilterLeads">
                    <option value="">All Types</option>
                </select>
            </div>
            <div>
                <label>Status:</label>
                <select id="statusFilterLeads">
                    <option value="">All Status</option>
                </select>
            </div>
            <div>
                <label>Salesman:</label>
                <select id="salesmanFilterLeads">
                    <option value="">All Salesmen</option>
                </select>
            </div>
            <div>
                <button type="button" id="clearFiltersLeads">Clear Filters</button>
            </div>
        </div>
        <div>
            <div>
                <button type="button" onclick="setAction('approve','leads')">
                    Approve Selected
                </button>
                <button type="button" onclick="setAction('reject','leads')">
                    Reject Selected
                </button>
                <button type="button" onclick="setAction('pending','leads')">
                    Mark Pending
                </button>
                <button type="button" onclick="setAction('delete','leads')">
                    Delete Selected
                </button>
                {% if perms.inventory.add_listing %}
                <div>
                    <a href="{% url 'inventory:listing_create_manager' %}">
                        Create New Listing
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <div>
            {% if listings %}
            <table id="manager-leads-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Salesman</th>
                        <th>Status</th>
                        <th><input type="checkbox" id="select_all" onchange="toggleSelectAll(this)"> </th>
                    </tr>
                </thead>
                <tbody>
                    {% for listing in listings %}
                    <tr>
                        <td>
                            <a href="{% url 'inventory:listing_detail' listing.pk %}">
                                {{ listing.id }}
                            </a>
                        </td>
                        <td>{{ listing.title }}</td>
                        <td>{{ listing.get_type_display }}</td>
                        <td>${{ listing.proposed_price|floatformat:0 }}</td>
                        <td>{{ listing.assigned_salesman.get_full_name|default:listing.assigned_salesman.username|default:"—" }}</td>
                        <td>
                            <span>
                                {{ listing.get_lead_status_display }}
                            </span>
                        </td>
                        <td>
                            <input type="checkbox" name="listing_ids" value="{{ listing.id }}" class="listing-checkbox">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No listings found.</p>
            {% endif %}
        </div>
    </form>
</div>

<div id="opportunity" class="tabcontent" style="display: none;">
    <form method="post" id="batch-form-opps">
        {% csrf_token %}
        <input type="hidden" name="action" id="batch-action-opps" value="">
        <input type="hidden" name="rejection-reason" id="rejection-reason-opps" value="">
        <input type="hidden" name="stage" id="stage-opps" value="opportunity">
        <div>
            <div>
                <label>Property Type:</label>
                <select id="typeFilterOpps">
                    <option value="">All Types</option>
                </select>
            </div>
            <div>
                <label>Status:</label>
                <select id="statusFilterOpps">
                    <option value="">All Status</option>
                </select>
            </div>
            <div>
                <label>Salesman:</label>
                <select id="salesmanFilterOpps">
                    <option value="">All Salesmen</option>
                </select>
            </div>
            <div>
                <button type="button" id="clearFiltersOpps">Clear Filters</button>
            </div>
        </div>
        <div>
            <div>
                <button type="button" onclick="setAction('approve','opps')">
                    Approve Selected
                </button>
                <button type="button" onclick="setAction('reject','opps')">
                    Reject Selected
                </button>
                <button type="button" onclick="setAction('pending','opps')">
                    Mark Pending
                </button>
                <button type="button" onclick="setAction('delete','opps')">
                    Delete Selected
                </button>
                {% if perms.inventory.add_listing %}
                <div>
                    <a href="{% url 'inventory:listing_create_manager' %}">
                        Create New Listing
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        <div>
            {% if listings %}
            <table id="manager-opps-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Salesman</th>
                        <th>Status</th>
                        <th><input type="checkbox" id="select_all_opps" onchange="toggleSelectAll(this)"> </th>
                    </tr>
                </thead>
                <tbody>
                    {% for listing in listings %}
                    {% if listing.lead_status == "Approved" %}
                    <tr>
                        <td>
                            <a href="{% url 'inventory:listing_detail' listing.pk %}">
                                {{ listing.id }}
                            </a>
                        </td>
                        <td>{{ listing.title }}</td>
                        <td>{{ listing.get_type_display }}</td>
                        <td>${{ listing.proposed_price|floatformat:0 }}</td>
                        <td>{{ listing.assigned_salesman.get_full_name|default:listing.assigned_salesman.username|default:"—" }}</td>
                        <td>
                            <span>
                                {{ listing.get_opp_status_display }}
                            </span>
                        </td>
                        <td>
                            <input type="checkbox" name="listing_ids" value="{{ listing.id }}" class="listing-checkbox">
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No listings found.</p>
            {% endif %}
        </div>
    </form>
</div>

<div id="sale" class="tabcontent" style="display: none">
    <form method="post" id="batch-form-sale">
        {% csrf_token %}
        <input type="hidden" name="action" id="batch-action-sale" value="">
        <input type="hidden" name="rejection-reason" id="rejection-reason-sale" value="">
        <input type="hidden" name="stage" id="stage-sale" value="sale">
        <div>
            <div>
                <label>Property Type:</label>
                <select id="typeFilterSale">
                    <option value="">All Types</option>
                </select>
            </div>
            <div>
                <label>Status:</label>
                <select id="statusFilterSale">
                    <option value="">All Status</option>
                </select>
            </div>
            <div>
                <label>Salesman:</label>
                <select id="salesmanFilterSale">
                    <option value="">All Salesmen</option>
                </select>
            </div>
            <div>
                <button type="button" id="clearFiltersSale">Clear Filters</button>
            </div>
        </div>
        <div>
            <button type="button" onclick="setAction('delete','opps')">
                Delete Selected
            </button>
            {% if perms.inventory.add_listing %}
            <div>
                <a href="{% url 'inventory:listing_create_manager' %}">
                    Create New Listing
                </a>
            </div>
            {% endif %}
        </div>
        <div>
            {% if listings %}
            <table id="manager-sales-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Title</th>
                        <th>Type</th>
                        <th>Price</th>
                        <th>Salesman</th>
                        <th>Status</th>
                        <th><input type="checkbox" id="select_all_sales" onchange="toggleSelectAll(this)"> </th>
                    </tr>
                </thead>
                <tbody>
                    {% for listing in listings %}
                    {% if listing.opp_status == "Approved" %}
                    <tr>
                        <td>
                            <a href="{% url 'inventory:listing_detail' listing.pk %}">
                                {{ listing.id }}
                            </a>
                        </td>
                        <td>{{ listing.title }}</td>
                        <td>{{ listing.get_type_display }}</td>
                        <td>${{ listing.proposed_price|floatformat:0 }}</td>
                        <td>{{ listing.assigned_salesman.get_full_name|default:listing.assigned_salesman.username|default:"—" }}</td>
                        <td>
                            <span>
                                {{ listing.get_sale_status_display }}
                            </span>
                        </td>
                        <td>
                            <input type="checkbox" name="listing_ids" value="{{ listing.id }}" class="listing-checkbox">
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>No listings found.</p>
            {% endif %}
        </div>
    </form>
</div>

{% endblock %}