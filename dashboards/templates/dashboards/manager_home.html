{% extends 'base.html' %}
{% load static %}
{% load compress %}

{% block title %}Home - Manager{% endblock %}
{% block page_title %}Welcome, {{ request.user.first_name }}!{% endblock %}
{% block page_subtitle %}Team Overview - {{ request.user.branch.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Row 1: Charts -->
    <div class="row mb-4">
        <!-- Half Donut - Total Listings -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="chart-card">
                <div class="card-title">Team Listings</div>
                <div class="half-donut-wrapper" id="listings-donut" 
                     data-leads="{{ total_leads }}" 
                     data-opportunities="{{ total_opportunities }}" 
                     data-sales="{{ total_sales }}">
                    <svg viewBox="0 0 200 100" width="200" height="100">
                        <defs>
                            <linearGradient id="leadsGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#3498db"/>
                                <stop offset="100%" stop-color="#2980b9"/>
                            </linearGradient>
                            <linearGradient id="oppsGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#f39c12"/>
                                <stop offset="100%" stop-color="#e67e22"/>
                            </linearGradient>
                            <linearGradient id="salesGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#27ae60"/>
                                <stop offset="100%" stop-color="#229954"/>
                            </linearGradient>
                        </defs>
                        <path class="track" fill="none" stroke="#e9ecef" stroke-width="20" stroke-linecap="round"
                              d="M 20 100 A 80 80 0 0 1 180 100"/>
                        <path id="leads-arc" fill="none" stroke="url(#leadsGradient)" stroke-width="20" stroke-linecap="round"
                            d="M 20 100 A 80 80 0 0 1 180 100" stroke-dasharray="0 251.2"/>
                        <path id="opps-arc" fill="none" stroke="url(#oppsGradient)" stroke-width="20" stroke-linecap="round"
                            d="M 20 100 A 80 80 0 0 1 180 100" stroke-dasharray="0 251.2"/>
                        <path id="sales-arc" fill="none" stroke="url(#salesGradient)" stroke-width="20" stroke-linecap="round"
                            d="M 20 100 A 80 80 0 0 1 180 100" stroke-dasharray="0 251.2"/>
                    </svg>
                    <div class="center-value">
                        <span class="center-number">{{ total_listings }}</span>
                        <span class="center-label">Total</span>
                    </div>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <span class="legend-color leads"></span>
                        <span>Leads ({{ total_leads }})</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color opportunities"></span>
                        <span>Opps ({{ total_opportunities }})</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color sales"></span>
                        <span>Sales ({{ total_sales }})</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Half Donut - Revenue Progress -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="chart-card">
                <div class="card-title">Revenue Progress</div>
                <div class="semi-circle-wrapper" data-percentage="{{ revenue_percentage }}">
                    <svg viewBox="0 0 200 100" width="200" height="100">
                        <defs>
                            <linearGradient id="revenueGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#28a745"/>
                                <stop offset="100%" stop-color="#20c997"/>
                            </linearGradient>
                        </defs>
                        <path class="track" d="M 20 100 A 80 80 0 0 1 180 100"/>
                        <path class="progress-bar revenue-bar" stroke="url(#revenueGradient)" d="M 20 100 A 80 80 0 0 1 180 100"/>
                    </svg>
                    <div class="percentage-container">
                        <span class="percentage-value revenue-percentage">0%</span>
                        <span class="percentage-label">of Target</span>
                    </div>
                </div>
                <div class="stats-footer">
                    <div class="stat-item">
                        <div class="stat-value actual">₹{{ actual_revenue|floatformat:0|default:"0" }}</div>
                        <div class="stat-label">Actual</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value projected">₹{{ projected_revenue|floatformat:0|default:"0" }}</div>
                        <div class="stat-label">Projected</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Semi-Circle - Sales Won Rate -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="chart-card">
                <div class="card-title">Team Won Rate</div>
                <div class="semi-circle-wrapper" data-percentage="{{ won_percentage }}">
                    <svg viewBox="0 0 200 100" width="200" height="100">
                        <defs>
                            <linearGradient id="wonGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stop-color="#1e3c72"/>
                                <stop offset="100%" stop-color="#2a5298"/>
                            </linearGradient>
                        </defs>
                        <path class="track" d="M 20 100 A 80 80 0 0 1 180 100"/>
                        <path class="progress-bar won-bar" stroke="url(#wonGradient)" d="M 20 100 A 80 80 0 0 1 180 100"/>
                    </svg>
                    <div class="percentage-container">
                        <span class="percentage-value won-percentage">0%</span>
                        <span class="percentage-label">Won</span>
                    </div>
                </div>
                <div class="stats-footer">
                    <div class="stat-item">
                        <div class="stat-value won">{{ sale_won }}</div>
                        <div class="stat-label">Won</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value lost">{{ sale_lost }}</div>
                        <div class="stat-label">Lost</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value total">{{ total_closed }}</div>
                        <div class="stat-label">Closed</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Total Revenue -->
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="revenue-card">
                <div class="revenue-label">Team Revenue</div>
                <div class="revenue-amount">₹{{ actual_revenue|floatformat:0|default:"0" }}</div>
                <div class="revenue-sub">
                    <i class="bi bi-graph-up-arrow"></i> 
                    {{ revenue_percentage }}% of ₹{{ projected_revenue|floatformat:0|default:"0" }} target
                </div>
                <div class="team-badge">
                    <i class="bi bi-people"></i> {{ team_size }} Team Members
                </div>
            </div>
        </div>
    </div>
    
    <!-- Row 2: KPI Cards -->
    <div class="row">
        <!-- Leads KPI Card -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon leads">
                        <i class="bi bi-bullseye"></i>
                    </div>
                    <div>
                        <div class="kpi-title">Leads</div>
                        <div class="kpi-total">{{ total_leads }} Total</div>
                    </div>
                </div>
                <ul class="kpi-list">
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot pending"></span>
                            <span>Pending Approval</span>
                        </div>
                        <span class="kpi-count">{{ lead_pending }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot approved"></span>
                            <span>Approved</span>
                        </div>
                        <span class="kpi-count">{{ lead_approved }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot rejected"></span>
                            <span>Rejected</span>
                        </div>
                        <span class="kpi-count">{{ lead_rejected }}</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Opportunities KPI Card -->
        <div class="col-lg-4 col-md-6 mb-4">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon opportunities">
                        <i class="bi bi-lightning-charge"></i>
                    </div>
                    <div>
                        <div class="kpi-title">Opportunities</div>
                        <div class="kpi-total">{{ total_opportunities }} Total</div>
                    </div>
                </div>
                <ul class="kpi-list">
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot prospecting"></span>
                            <span>Prospecting</span>
                        </div>
                        <span class="kpi-count">{{ opp_prospecting }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot negotiating"></span>
                            <span>Negotiating</span>
                        </div>
                        <span class="kpi-count">{{ opp_negotiating }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot pending"></span>
                            <span>Pending Approval</span>
                        </div>
                        <span class="kpi-count">{{ opp_pending }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot approved"></span>
                            <span>Approved</span>
                        </div>
                        <span class="kpi-count">{{ opp_approved }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot rejected"></span>
                            <span>Rejected</span>
                        </div>
                        <span class="kpi-count">{{ opp_rejected }}</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Sales KPI Card -->
        <div class="col-lg-4 col-md-12 mb-4">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon sales">
                        <i class="bi bi-cash-stack"></i>
                    </div>
                    <div>
                        <div class="kpi-title">Sales</div>
                        <div class="kpi-total">{{ total_sales }} Total</div>
                    </div>
                </div>
                <ul class="kpi-list">
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot processing"></span>
                            <span>Processing</span>
                        </div>
                        <span class="kpi-count">{{ sale_processing }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot won"></span>
                            <span>Closed Won</span>
                        </div>
                        <span class="kpi-count">{{ sale_won }}</span>
                    </li>
                    <li>
                        <div class="kpi-status">
                            <span class="status-dot lost"></span>
                            <span>Closed Lost</span>
                        </div>
                        <span class="kpi-count">{{ sale_lost }}</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/charts.js' %}"></script>
{% endblock %}